pipeline {
  agent any
  stages {
    stage('build') {
      steps {
        sh 'cargo build --workspace'
      }
    }
    stage('setup vcan') {
      steps {
        sh '''
          sudo modprobe vcan || true
          sudo modprobe can-bcm || true
          sudo ip link add dev vcan0 type vcan || true
          sudo ip link set up vcan0
        '''
      }
    }
    stage('tests') {
      steps {
        sh '''
          python3 -m venv .venv
          . .venv/bin/activate
          pip install -U pip
          pip install -r tests/requirements.txt
          # install afb-test-py from local source (example)
          pip install ./third-party/afb-test-py

          mkdir -p reports
          export LD_LIBRARY_PATH="$PWD/target/debug:${LD_LIBRARY_PATH:-}"
          pytest -q --junitxml=reports/afb-functional.xml tests/functional
        '''
      }
      post {
        always {
          junit 'reports/*.xml'
        }
      }
    }
  }
}
